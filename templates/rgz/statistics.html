{% extends "rgz/base.html" %}
{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–Ω–∫–∞{% endblock %}
{% block content %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

<div class="fade-in">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title"><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–Ω–∫–∞</h2>
        </div>
        
        <div id="statisticsContainer">
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: #1a237e;"></i>
                <p style="margin-top: 1rem;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadStatistics() {
        try {
            const result = await apiCall('/rgz/api/statistics');
            if (result.statistics) {
                renderStatistics(result.statistics);
            }
        } catch (error) {
            document.getElementById('statisticsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}
                </div>
            `;
        }
    }
    
    function renderStatistics(stats) {
        const html = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="info-card">
                    <i class="fas fa-users fa-2x"></i>
                    <h3>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div class="amount">${stats.total_users}</div>
                </div>
                
                <div class="info-card" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                    <i class="fas fa-user-tie fa-2x"></i>
                    <h3>–ö–ª–∏–µ–Ω—Ç–æ–≤</h3>
                    <div class="amount">${stats.total_clients}</div>
                </div>
                
                <div class="info-card" style="background: linear-gradient(135deg, #2196f3 0%, #0d47a1 100%);">
                    <i class="fas fa-user-shield fa-2x"></i>
                    <h3>–ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</h3>
                    <div class="amount">${stats.total_managers}</div>
                </div>
                
                <div class="info-card" style="background: linear-gradient(135deg, #9c27b0 0%, #6a1b9a 100%);">
                    <i class="fas fa-coins fa-2x"></i>
                    <h3>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h3>
                    <div class="amount">${formatMoney(stats.total_balance)}</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div class="card">
                    <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-pie"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                    <canvas id="activityChart" width="400" height="300"></canvas>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
                    <canvas id="weeklyChart" width="400" height="300"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 1rem;"><i class="fas fa-trophy"></i> –¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –±–∞–ª–∞–Ω—Å—É</h3>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–ë–∞–ª–∞–Ω—Å</th>
                                <th>–£—Ä–æ–≤–µ–Ω—å</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stats.top_clients.map((client, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong></td>
                                    <td>${client.full_name}</td>
                                    <td style="font-weight: bold; color: #4caf50;">
                                        ${formatMoney(client.balance)}
                                    </td>
                                    <td>
                                        <span style="padding: 0.3rem 0.8rem; border-radius: 20px; 
                                              background: ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#e0e0e0'}; 
                                              color: ${index < 3 ? 'white' : '#333'}">
                                            ${index === 0 ? 'ü•á –ó–æ–ª–æ—Ç–æ' : index === 1 ? 'ü•à –°–µ—Ä–µ–±—Ä–æ' : index === 2 ? 'ü•â –ë—Ä–æ–Ω–∑–∞' : '–°—Ç–∞–Ω–¥–∞—Ä—Ç'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        document.getElementById('statisticsContainer').innerHTML = html;
        
        // –î–∏–∞–≥—Ä–∞–º–º–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
        const activityCtx = document.getElementById('activityChart').getContext('2d');
        new Chart(activityCtx, {
            type: 'doughnut',
            data: {
                labels: ['–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã', '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã'],
                datasets: [{
                    data: [stats.active_clients, stats.inactive_clients],
                    backgroundColor: ['#4caf50', '#f44336'],
                    borderWidth: 2,
                    borderColor: 'white'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // –î–∏–∞–≥—Ä–∞–º–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –Ω–µ–¥–µ–ª—é
        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        const weeklyLabels = stats.weekly_stats.map(s => s.date);
        const weeklyData = stats.weekly_stats.map(s => s.transactions_count);
        
        new Chart(weeklyCtx, {
            type: 'line',
            data: {
                labels: weeklyLabels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π',
                    data: weeklyData,
                    borderColor: '#1a237e',
                    backgroundColor: 'rgba(26, 35, 126, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–î–∞—Ç–∞'
                        }
                    }
                }
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', loadStatistics);
</script>
{% endblock %}